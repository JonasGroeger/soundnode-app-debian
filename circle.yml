#######################
# Additional settings #
#######################
#
# 1. PACKAGECLOUD_TOKEN env var from https://packagecloud.io/docs#circle_ci
# 2. CIRCLE_TAG env var from build trigger

machine:
  node:
    version: 6.1.0

checkout:
  pre:
    - GIT_TAG="$(git describe --tags --abbrev=0 --match='[0-9]*.[0-9]*.[0-9]*')"
  post:
    - git clone -b "$GIT_TAG" --single-branch --depth 1 https://github.com/Soundnode/soundnode-app.git src

dependencies:
  override:
    - apt-get -y --no-install-recommends install bash build-essential curl git imagemagick jq ruby ruby-dev
    - gem install --no-ri --no-rdoc fpm package_cloud
    - (cd src; npm install --dev)

compile:
  override:
    - (cd src; npm run package:linux)
    - ./build-deb
  post:
    - mv dist/*.deb "$CIRCLE_ARTIFACTS/"

test:
  override:
    - echo "Skip the tests."

deployment:
  release:
    tag: /[0-9]+(\.[0-9]+)*/
    owner: JonasGroeger
    commands:
      - ./push-deb "$CIRCLE_ARTIFACTS"
